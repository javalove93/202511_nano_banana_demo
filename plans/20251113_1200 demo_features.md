# Nano Banana Demo 기능 분석

이 문서는 Nano Banana 데모 애플리케이션의 데모 저장 및 불러오기 기능에 대한 분석 내용을 담고 있습니다.

## 1. 데모 저장 기능 (`/save_nano_banana_demo`)

데모 저장 기능은 사용자가 생성한 나노 바나나 데모를 시스템에 영구적으로 보관하는 역할을 합니다.

### 주요 흐름

1.  **데이터 수신**: 클라이언트로부터 HTTP POST 요청을 통해 데모 데이터를 수신합니다.
    *   **Endpoint**: `/save_nano_banana_demo`
    *   **필수 데이터**:
        *   `title`: 데모 제목 (문자열)
        *   `images`: Base64로 인코딩된 이미지 데이터 배열
    *   **선택 데이터**:
        *   `fixed_prompt_header`: 고정 프롬프트 헤더 (문자열)
        *   `main_prompt`: 메인 프롬프트 (문자열)

2.  **데이터 유효성 검사**: `title`과 `images` 데이터가 존재하는지 확인합니다. 하나라도 누락되면 400 에러를 반환합니다.

3.  **이미지 처리 및 GCS 업로드**:
    *   수신된 Base64 이미지 데이터를 디코딩합니다.
    *   Pillow 라이브러리를 사용하여 모든 이미지를 **PNG 형식으로 변환**합니다. 이는 일관된 데이터 형식을 유지하기 위함입니다.
    *   각 이미지에 대해 고유한 `UUID`를 생성하여 파일명으로 사용합니다.
    *   환경 변수 `SHOWCASE_GCS_PATH`에 지정된 GCS 버킷 및 폴더 경로에 PNG 이미지를 업로드합니다.
    *   업로드된 이미지의 GCS 경로 (`gs://<bucket_name>/<folder_prefix>/nanobanana/<uuid>.png`)를 리스트에 저장합니다.

4.  **Firestore 데이터 저장**:
    *   `nanobanana` 라는 이름의 Firestore 컬렉션에 새로운 문서를 생성합니다.
    *   저장되는 정보는 다음과 같습니다:
        *   `title`: 데모 제목
        *   `fixed_prompt_header`: 고정 프롬프트 헤더
        *   `main_prompt`: 메인 프롬프트
        *   `images`: GCS에 업로드된 이미지 경로 리스트
        *   `timestamp`: 서버 시간을 기준으로 한 타임스탬프

5.  **결과 반환**: 모든 과정이 성공적으로 완료되면, 클라이언트에 성공 상태와 함께 생성된 Firestore 문서의 ID를 반환합니다. 오류 발생 시, 해당 오류 메시지와 함께 500 에러를 반환합니다.

## 2. 데모 목록 불러오기 기능 (`/list_nano_banana_demos`)

저장된 모든 데모의 목록을 클라이언트에 제공하는 기능입니다.

### 주요 흐름

1.  **데이터 요청**: 클라이언트로부터 HTTP GET 요청을 수신합니다.
    *   **Endpoint**: `/list_nano_banana_demos`

2.  **Firestore 데이터 조회**:
    *   `nanobanana` 컬렉션의 모든 문서를 조회합니다.
    *   `timestamp` 필드를 기준으로 **내림차순 정렬**하여 최신 데모가 가장 먼저 오도록 합니다.

3.  **데이터 후처리**:
    *   Firestore의 `Timestamp` 객체를 클라이언트에서 사용하기 쉬운 ISO 8601 형식의 문자열로 변환합니다.

4.  **결과 반환**: 조회된 데모 목록을 JSON 배열 형태로 클라이언트에 반환합니다. 오류 발생 시, 오류 메시지와 함께 500 에러를 반환합니다.

## 3. GCS 이미지 조회 기능 (`/get_gcs_image`)

Firestore에 저장된 GCS 이미지 경로를 이용하여 실제 이미지 데이터를 클라이언트에 제공하는 기능입니다.

### 주요 흐름

1.  **이미지 요청**: 클라이언트로부터 HTTP GET 요청을 수신합니다.
    *   **Endpoint**: `/get_gcs_image`
    *   **쿼리 파라미터**: `gcs_path` (예: `gs://my-bucket/images/nanobanana/image.png`)

2.  **GCS 경로 파싱**:
    *   `gcs_path` 파라미터의 유효성을 검사하고, 버킷 이름과 파일 객체 이름을 분리합니다.

3.  **GCS 이미지 다운로드 및 스트리밍**:
    *   파싱된 정보를 사용하여 GCS에서 해당 이미지 파일을 찾습니다.
    *   파일이 존재하지 않으면 404 에러를 반환합니다.
    *   파일이 존재하면, 해당 파일의 데이터를 바이트 스트림 형태로 클라이언트에 직접 전송합니다. 이를 통해 서버에 불필요한 파일 저장을 피하고 효율적으로 이미지를 전달합니다.

4.  **결과 반환**: 이미지 데이터와 함께 적절한 `Content-Type` 헤더를 포함하여 HTTP Response를 반환합니다. 오류 발생 시, 500 에러를 반환합니다.
